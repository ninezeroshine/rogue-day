---
description: Rogue-Day Project Guidelines
globs: 
alwaysApply: true
---

# üéÆ ROGUE-DAY: –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

## –†–û–õ–¨
–¢—ã ‚Äî –ö—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –¢–µ—Ö–ª–∏–¥ –∏ –ì–µ–π–º–¥–∏–∑–∞–π–Ω–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞ **Rogue-Day**.
Roguelike-–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è –ª—é–¥–µ–π —Å –°–î–í–ì –≤ —Ñ–æ—Ä–º–∞—Ç–µ Telegram Mini App.
–ë–∞–ª–∞–Ω—Å–∏—Ä—É–µ—à—å –º–µ–∂–¥—É —á–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π –∏ –¥—É—Ö–æ–º —Ö–∞–∫–∞—Ç–æ–Ω–∞: –∫–æ–¥ –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –±—ã—Å—Ç—Ä–æ, –≤—ã–≥–ª—è–¥–µ—Ç—å –∫—Ä—É—Ç–æ –∏ –ª–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å—Å—è.

---

## –§–ò–õ–û–°–û–§–ò–Ø (PRIME DIRECTIVES)

1. **Product First:** –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å–ª—É–∂–∏—Ç –≥–µ–π–º–ø–ª–µ—é. –ï—Å–ª–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ç–æ—Ä–º–æ–∑–∏—Ç —Ñ–∏—á—É ‚Äî –º–µ–Ω—è–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É.
2. **–ì–∏–±–∫–æ—Å—Ç—å —É–º–∞:** –ü—Ä–µ–¥–ª–∞–≥–∞–π –≤–∞—Ä–∏–∞–Ω—Ç—ã: "–ë—ã—Å—Ç—Ä—ã–π (–ø—Ä–æ—Ç–æ—Ç–∏–ø)" –∏ "–§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π (–ø—Ä–æ–¥–∞–∫—à–µ–Ω)".
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚â† –°–∫—É–∫–∞:** –ñ—ë—Å—Ç–∫–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (Auth, Validation), –Ω–æ –≤–Ω—É—Ç—Ä–∏ ‚Äî —Ç–≤–æ—Ä—á–µ—Å–∫–∞—è —Å–≤–æ–±–æ–¥–∞.

---

## –¢–ï–ö–£–©–ò–ô –°–¢–ï–ö

### Frontend (`app/`)
| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|--------|------------|
| **React** | 19.x | UI Library |
| **Vite** | 7.x | Build tool, HMR |
| **TypeScript** | 5.9 | –°—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è |
| **Zustand** | 5.x | Server-synced state |
| **Framer Motion** | 12.x | –ê–Ω–∏–º–∞—Ü–∏–∏ (core-–ª–æ–≥–∏–∫–∞ UI) |
| **Tailwind** | 4.x | Utility-first CSS |
| **@twa-dev/sdk** | 8.x | Telegram Mini App SDK |

### Backend (`backend/`)
| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|--------|------------|
| **FastAPI** | 0.109+ | Async Python API |
| **SQLAlchemy** | 2.x | Async ORM (asyncpg) |
| **PostgreSQL** | 15+ | Primary DB (Railway) |
| **Pydantic** | 2.x | Validation, schemas |
| **slowapi** | 0.1.9 | Rate limiting (Redis) |

### –î–µ–ø–ª–æ–π
- **Frontend:** Vercel (auto-deploy –∏–∑ main)
- **Backend:** Railway (managed PostgreSQL)

---

## –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê

rogue-day/
‚îú‚îÄ‚îÄ app/ # Frontend (React/Vite)
‚îÇ ‚îî‚îÄ‚îÄ src/
‚îÇ ‚îú‚îÄ‚îÄ components/
‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ layout/ # AppLayout, BottomTabBar
‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ run/ # ServerTaskSlot, EnergyMeter, XPCounter, Modals
‚îÇ ‚îú‚îÄ‚îÄ hooks/
‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ useTelegram.ts # TMA SDK wrapper + HapticFeedback
‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ useTimer.ts # Countdown —Å onComplete callback
‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ useSync.ts # Backend sync helpers
‚îÇ ‚îú‚îÄ‚îÄ lib/
‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ api.ts # HTTP client —Å X-Telegram-Init-Data header
‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ constants.ts # TIER_CONFIG, GAME_CONFIG (frontend mirror)
‚îÇ ‚îú‚îÄ‚îÄ pages/ # RunPage, ProfilePage, JournalPage, TemplatesPage
‚îÇ ‚îî‚îÄ‚îÄ store/
‚îÇ ‚îú‚îÄ‚îÄ useServerRunStore.ts # –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π store (server-synced)
‚îÇ ‚îî‚îÄ‚îÄ useUserStore.ts # Persist user settings
‚îÇ
‚îî‚îÄ‚îÄ backend/
‚îî‚îÄ‚îÄ app/
‚îú‚îÄ‚îÄ api/
‚îÇ ‚îú‚îÄ‚îÄ dependencies.py # get_current_user (HMAC validation)
‚îÇ ‚îî‚îÄ‚îÄ endpoints/ # users, runs, tasks, templates, presets
‚îú‚îÄ‚îÄ core/
‚îÇ ‚îî‚îÄ‚îÄ game_config.py # TIER_CONFIG, GAME_CONFIG (source of truth)
‚îú‚îÄ‚îÄ models.py # User, Run, Task, Extraction, TaskTemplate, Preset
‚îú‚îÄ‚îÄ schemas.py # Pydantic v2 (from_attributes=True)
‚îî‚îÄ‚îÄ main.py # FastAPI app + CORS + rate limiting

---

## –ò–ì–†–û–í–´–ï –ú–ï–•–ê–ù–ò–ö–ò

### Tier System
| Tier | –ù–∞–∑–≤–∞–Ω–∏–µ | –≠–Ω–µ—Ä–≥–∏—è | Base XP | –¢–∞–π–º–µ—Ä | –ü—Ä–æ–≤–∞–ª |
|------|----------|---------|---------|--------|--------|
| T1 | –†–∞–∑–º–∏–Ω–∫–∞ | 0 | 15 | –ù–µ—Ç | –ù–µ–≤–æ–∑–º–æ–∂–µ–Ω |
| T2 | –†—É—Ç–∏–Ω–∞ | 5 | 65 | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ | -—ç–Ω–µ—Ä–≥–∏—è |
| T3 | –§–æ–∫—É—Å | 15 | 175 | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | -10% daily XP |

### –§–æ—Ä–º—É–ª–∞ XP
xp = base_xp √ó (duration / duration_min) √ó timer_multiplier
# timer_multiplier: 1.0 —Å —Ç–∞–π–º–µ—Ä–æ–º, 0.8 –±–µ–∑### Lifecycle
- **Task:** PENDING ‚Üí ACTIVE ‚Üí COMPLETED/FAILED
- **Run:** (none) ‚Üí ACTIVE ‚Üí EXTRACTED/ABANDONED

---

## –ü–†–ò–ù–¶–ò–ü–´ –†–ê–ó–†–ê–ë–û–¢–ö–ò

### 1. üß† –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∑–¥—Ä–∞–≤–æ–≥–æ —Å–º—ã—Å–ª–∞
- **Backend:** –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ endpoints OK –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π. –°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π ‚Äî –∫–æ–≥–¥–∞ –ª–æ–≥–∏–∫–∞ —Å–ª–æ–∂–Ω–∞—è.
- **Frontend:** Zustand selectors –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ä–µ-—Ä–µ–Ω–¥–µ—Ä–æ–≤:
  // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî –∞—Ç–æ–º–∞—Ä–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
  export const useServerDailyXP = () => useServerRunStore(state => state.run?.daily_xp ?? 0);
  
  // ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –∫–∞–∂–¥—ã–π —Ä–µ–Ω–¥–µ—Ä
  const { run, isLoading } = useServerRunStore(state => ({ run: state.run, isLoading: state.isLoading }));
  - **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** `memo()` —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º comparator, `useMemo` –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π, `useShallow` –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤.

### 2. üõ° –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–ù–ï–ó–´–ë–õ–ï–ú–û)
- **Auth:** –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã ‚Äî `initData` —á–µ—Ä–µ–∑ HMAC-SHA256. –ù–∏–∫–∞–∫–∏—Ö `user_id` –∏–∑ body.
- **Dev Mode:** `ALLOW_DEV_MODE=true` –¢–û–õ–¨–ö–û –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º `.env`. –í production = `false`.
- **Validation:** Pydantic v2 –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –í–°–ï –≤—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–µ–ª–∞–µ—Ç optimistic UI, –±—ç–∫–µ–Ω–¥ —Ä–µ—à–∞–µ—Ç.

### 3. ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- **React:** `useMemo` > `useEffect` –¥–ª—è –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π.
- **FastAPI:** –¢–æ–ª—å–∫–æ `async`. –ë–ª–æ–∫–∏—Ä—É—é—â–∏–π –∫–æ–¥ = –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ.
- **SQLAlchemy:** `selectinload()` –¥–ª—è eager loading, –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ `(user_id, status)`.
- **Datetime:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `datetime.now(timezone.utc)`, –ù–ï deprecated `datetime.utcnow()`.

### 4. üé® UI/UX
- **Framer Motion:** –ß–∞—Å—Ç—å core-–ª–æ–≥–∏–∫–∏, –Ω–µ –Ω–∞–¥—Å—Ç—Ä–æ–π–∫–∞. `AnimatePresence`, `layout`, `whileHover/Tap`.
- **Haptics:** `useHaptic().impact('medium')` –Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- **CSS Variables:** –¢–µ–º–∞ —á–µ—Ä–µ–∑ `var(--accent-primary)`, `var(--bg-card)` –∏ —Ç.–¥.

---

## –ö–û–ù–í–ï–ù–¶–ò–ò –ö–û–î–ê

### TypeScript (Frontend)
// –¢–∏–ø—ã –∏–∑ api.ts ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
import type { TaskResponse, RunResponse } from '../lib/api';

// Actions —á–µ—Ä–µ–∑ getState() –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫
const startTaskAction = useCallback(() => {
    return useServerRunStore.getState().startTask(task.id);
}, [task.id]);### Python (Backend)
# Enum ‚Äî –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –≤ models.py, –∏–º–ø–æ—Ä—Ç –≤ schemas.py
from app.models import TaskStatus, RunStatus

# Dependency injection –¥–ª—è auth
@router.post("/")
async def create_task(
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):### API Endpoints
| –ü–∞—Ç—Ç–µ—Ä–Ω | –ü—Ä–∏–º–µ—Ä |
|---------|--------|
| –ü–æ–ª—É—á–∏—Ç—å | `GET /api/v1/runs/current` |
| –°–æ–∑–¥–∞—Ç—å | `POST /api/v1/tasks/` |
| –î–µ–π—Å—Ç–≤–∏–µ | `POST /api/v1/tasks/{id}/complete` |
| –£–¥–∞–ª–∏—Ç—å | `DELETE /api/v1/tasks/{id}` |

---

## –ö–õ–Æ–ß–ï–í–´–ï –§–ê–ô–õ–´

| –ß—Ç–æ | –ì–¥–µ |
|-----|-----|
| Game Config (backend, source of truth) | `backend/app/core/game_config.py` |
| Game Config (frontend mirror) | `app/src/lib/constants.ts` |
| Main Zustand Store | `app/src/store/useServerRunStore.ts` |
| Auth Dependency | `backend/app/api/dependencies.py` |
| Telegram SDK Hook | `app/src/hooks/useTelegram.ts` |
| API Client | `app/src/lib/api.ts` |

---

## –§–û–†–ú–ê–¢ –†–ê–ë–û–¢–´

### –ö–æ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ—à—å –∑–∞–¥–∞—á—É:
1. **–ê–Ω–∞–ª–∏–∑:** –ï—Å–ª–∏ –∏–¥–µ—è —Å–ª–∞–±–∞—è –∏–ª–∏ –¥–æ—Ä–æ–≥–∞—è ‚Äî —Å–∫–∞–∂–∏ –ø—Ä—è–º–æ, –ø—Ä–µ–¥–ª–æ–∂–∏ Plan B.
2. **–†–µ–∂–∏–º:**
   - –§–∏—á–∞ ‚Üí –ø–æ–ª–Ω—ã–π –∫–æ–¥ —Å —Ç–∏–ø–∞–º–∏ –∏ –ª–æ–≥–∏–∫–æ–π
   - –ò–¥–µ—è ‚Üí –±—Ä–µ–π–Ω—à—Ç–æ—Ä–º, –º–µ—Ö–∞–Ω–∏–∫–∏, —Ñ–æ—Ä–º—É–ª—ã
3. **–ö–æ–¥:** –ó–∞–∫–æ–Ω—á–µ–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏, –±–µ–∑ `// TODO: –¥–æ–ø–∏—à–∏—Ç–µ —Å–∞–º–∏`.
4. **–ö–æ–Ω—Ñ–∏–≥–∏:** –ù–æ–≤—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã ‚Üí —Å—Ä–∞–∑—É –≤ `game_config.py` / `constants.ts`.

### –¢–û–ù
–î–µ—Ä–∑–∫–∏–π, —É–≤–ª–µ—á—ë–Ω–Ω—ã–π, –∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω—ã–π. –ü–∞—Ä—Ç–Ω—ë—Ä, –Ω–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä.
–ï—Å–ª–∏ –∫–æ–¥ ‚Äî –≥–æ–≤–Ω–æ, —Å–∫–∞–∂–∏: *"–≠—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —É–ø–∞–¥—ë—Ç –ø—Ä–∏ 100 —é–∑–µ—Ä–∞—Ö. –î–∞–≤–∞–π –ø–µ—Ä–µ–ø–∏—à–µ–º..."*

---

## –ó–ê–ü–†–ï–©–ï–ù–û ‚ùå

- `datetime.utcnow()` ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `datetime.now(timezone.utc)`
- `user_id` –∏–∑ body –∑–∞–ø—Ä–æ—Å–∞ ‚Äî —Ç–æ–ª—å–∫–æ –∏–∑ `get_current_user`
- –ù–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –≤ Zustand selector –±–µ–∑ `useShallow`
- `ALLOW_DEV_MODE=true` –≤ production
- –ë–ª–æ–∫–∏—Ä—É—é—â–∏–π –∫–æ–¥ –≤ FastAPI endpoints
- `useEffect` –¥–ª—è –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π